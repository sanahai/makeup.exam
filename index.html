<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë©”ì´í¬ì—… ë§ˆìŠ¤í„° v13: ë²„ê·¸ ìˆ˜ì •íŒ</title>
    <style>
        /* CSSëŠ” ë™ì¼í•˜ë˜ ë ˆì´ì–´ ì•ˆì •ì„±ì„ ìœ„í•´ display ì†ì„± ê´€ë¦¬ ê°•í™” */
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --accent: #ffd93d; --bg: #f2f4f7; --blue-active: #3498db; --gray-done: #d1d8e0; --lock: #e9ecef; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 12px; display: none; } /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        .stage-box { background: white; padding: 18px; border-radius: 16px; margin-bottom: 12px; border-left: 6px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stage-title { font-size: 1rem; font-weight: 800; margin-bottom: 15px; }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn-action, .btn-full { display: flex; align-items: center; justify-content: center; padding: 16px 8px; border-radius: 12px; border: 1.5px solid #eee; background: #fff; cursor: pointer; font-weight: 700; font-size: 0.9rem; min-height: 54px; transition: 0.2s; }
        .btn-full { width: 100%; grid-column: span 3; margin-top: 4px; }
        .status-in-progress { background: var(--blue-active) !important; color: white !important; }
        .status-completed { background: var(--gray-done) !important; color: #7f8c8d !important; }
        .status-locked { background: var(--lock) !important; color: #adb5bd !important; border-style: dashed !important; opacity: 0.8; }
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
        #quiz-app { display: none; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 0 0 15px 15px; margin-bottom: 12px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .timer-badge { background: #333; color: var(--accent); padding: 4px 12px; border-radius: 12px; font-weight: 800; font-size: 0.95rem; }
        .q-card { background: white; padding: 22px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .q-text { font-size: 1.1rem; font-weight: 800; margin-bottom: 18px; }
        .option-btn { width: 100%; padding: 16px; text-align: left; border: 2px solid #f1f3f5; border-radius: 12px; background: white; cursor: pointer; margin-bottom: 10px; font-size: 0.95rem; }
        .option-btn.correct { background: #e8f5e9; border-color: #4caf50; color: #1b5e20; font-weight: bold; }
        .option-btn.wrong { background: #ffebee; border-color: #f44336; color: #b71c1c; }
        .exp-box { background: #fdf2f2; border-left: 4px solid var(--primary); padding: 15px; border-radius: 0 10px 10px 0; margin-top: 15px; font-size: 0.9rem; }
        .next-btn { width: 100%; padding: 18px; background: #2d3436; color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="font-size: 2rem;">â³</div>
    <div style="font-weight: bold; margin-top: 10px;">ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div id="load-status" style="font-size: 0.8rem; color: #888; margin-top: 5px;">ì¤€ë¹„ ì¤‘</div>
</div>

<div class="container" id="main-container">
    <div id="dashboard-view">
        <h1 style="text-align: center; font-size: 1.4rem; margin: 15px 0;">ğŸ¯ ë©”ì´í¬ì—… í•©ê²© ì‹œìŠ¤í…œ</h1>
        
        <div class="stage-box">
            <div class="stage-title">STAGE 1. ê³¼ëª©ë³„ ìˆœì°¨ íšŒë…</div>
            <div class="btn-grid">
                <button class="btn-action" id="btn-study-1" onclick="handleStageClick('study', 1, 0)">1íšŒì°¨</button>
                <button class="btn-action" id="btn-study-2" onclick="handleStageClick('study', 2, 120)">2íšŒì°¨</button>
                <button class="btn-action" id="btn-study-3" onclick="handleStageClick('study', 3, 60)">3íšŒì°¨</button>
            </div>
        </div>
        <div class="stage-box" style="border-left-color: var(--secondary);"><div class="stage-title">STAGE 2. ì˜¤ë‹µ ì†Œíƒ•</div><button class="btn-full" id="btn-wrong-round" onclick="handleStageClick('wrong', 'round', 60)">ì˜¤ë‹µ ì •ë³µ (<span id="cnt-round">0</span>)</button></div>
        <div class="stage-box" style="border-left-color: var(--accent);"><div class="stage-title">STAGE 3. ì‹¤ì „ ê¸°ì¶œ (5íšŒ)</div><div class="btn-grid" id="mock-btns"></div></div>
        <div class="stage-box" style="border-left-color: #2d3436;"><div class="stage-title">STAGE 4. ìµœì¢… ì˜¤ë‹µ ì •ë³µ</div><button class="btn-full" id="btn-wrong-final" onclick="handleStageClick('wrong', 'final', 40)">ê¸°ì¶œ ì˜¤ë‹µ ì†Œíƒ• (<span id="cnt-final">0</span>)</button></div>
        <div style="text-align: center; margin-top:20px;"><button onclick="resetData()" style="color:#bbb; border:none; background:none; font-size:0.8rem; text-decoration:underline; cursor:pointer;">ê¸°ë¡ ì´ˆê¸°í™”</button></div>
    </div>

    <div id="quiz-app">
        <div class="top-nav">
            <button onclick="exitQuiz()" style="border:none; background:none; font-weight:bold; cursor:pointer;">â—€ ì¤‘ë‹¨</button>
            <span id="q-category" style="color:var(--primary); font-weight:bold; font-size:0.85rem;">ê³¼ëª©</span>
            <span id="q-progress">0/0</span>
            <div id="timer" class="timer-badge">00:00</div>
        </div>
        <div class="q-card">
            <div id="q-text" class="q-text">ì§ˆë¬¸</div>
            <div id="options-area"></div>
            <div id="exp-area" class="exp-box" style="display:none;"></div>
            <button id="next-btn" class="next-btn" style="display:none;" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>
    </div>
</div>

<script>
    let questionsDB = [];
    let wrongStorage = { round: [], final: [] };
    let state = { questions: [], index: 0, timeLimit: 0, timeLeft: 0, timerId: null, currentRound: 1, mode: '', sessionKey: '', doneKey: '' };

    const fileNames = ['makeup1.json', 'makeup2.json', 'makeup3.json', 'makeup4.json'];

    async function loadData() {
        if (questionsDB.length > 0) return; // ì´ë¯¸ ë¡œë“œë¨
        let loaded = 0;
        try {
            for (const file of fileNames) {
                const response = await fetch(file + '?v=' + new Date().getTime()); // ìºì‹œ ë°©ì§€
                const data = await response.json();
                questionsDB = questionsDB.concat(data);
                loaded++;
                document.getElementById('load-status').innerText = `${loaded}/4 ì™„ë£Œ`;
            }
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            
            const savedWrongs = localStorage.getItem('makeup_wrongs');
            if (savedWrongs) wrongStorage = JSON.parse(savedWrongs);
            
            showDashboard();
        } catch (err) { 
            document.getElementById('load-status').innerText = "íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨. ê¹ƒí—ˆë¸Œ ì—…ë¡œë“œ í™•ì¸ í•„ìš”."; 
        }
    }

    window.onload = loadData;

    function showDashboard() {
        // ëª¨ë“  ë·° ì´ˆê¸°í™”
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('quiz-app').style.display = 'none';
        
        // ì˜¤ë‹µ ê°œìˆ˜ ê°±ì‹ 
        document.getElementById('cnt-round').innerText = Array.from(new Map(wrongStorage.round.map(q => [q.id, q])).values()).length;
        document.getElementById('cnt-final').innerText = Array.from(new Map(wrongStorage.final.map(q => [q.id, q])).values()).length;

        // ë²„íŠ¼ ì ê¸ˆ ë° ìƒ‰ìƒ ê°±ì‹ 
        updateBtn('btn-study-1', 'save_study_1', 'done_study_1', true);
        updateBtn('btn-study-2', 'save_study_2', 'done_study_2', localStorage.getItem('done_study_1'));
        updateBtn('btn-study-3', 'save_study_3', 'done_study_3', localStorage.getItem('done_study_2'));
        updateBtn('btn-wrong-round', 'save_wrong_round', 'done_wrong_round', localStorage.getItem('done_study_3'));

        const mockArea = document.getElementById('mock-btns');
        let prevMockDone = localStorage.getItem('done_wrong_round');
        mockArea.innerHTML = [1,2,3,4,5].map(n => {
            const saveKey = `save_mock_${n}`, doneKey = `done_mock_${n}`;
            let statusClass = prevMockDone ? '' : 'status-locked';
            if (localStorage.getItem(saveKey)) statusClass = 'status-in-progress';
            else if (localStorage.getItem(doneKey)) statusClass = 'status-completed';
            prevMockDone = localStorage.getItem(doneKey);
            return `<button class="btn-action ${statusClass}" id="btn-mock-${n}" onclick="handleStageClick('mock', ${n}, 40)">${statusClass.includes('locked') ? 'ğŸ”’ ' : ''}${n}íšŒ</button>`;
        }).join('');
        
        updateBtn('btn-wrong-final', 'save_wrong_final', 'done_wrong_final', localStorage.getItem('done_mock_5'));
    }

    function updateBtn(id, saveKey, doneKey, isUnlocked) {
        const btn = document.getElementById(id); if(!btn) return;
        btn.classList.remove('status-in-progress', 'status-completed', 'status-locked');
        btn.innerHTML = btn.innerHTML.replace('ğŸ”’ ', '');
        if (!isUnlocked) { btn.classList.add('status-locked'); btn.innerHTML = 'ğŸ”’ ' + btn.innerHTML; }
        else if (localStorage.getItem(saveKey)) btn.classList.add('status-in-progress');
        else if (localStorage.getItem(doneKey)) btn.classList.add('status-completed');
    }

    function handleStageClick(mode, round, limit) {
        const btnId = (mode === 'study') ? `btn-study-${round}` : (mode === 'wrong' ? `btn-wrong-${round}` : `btn-mock-${round}`);
        if (document.getElementById(btnId).classList.contains('status-locked')) { alert("ì´ì „ ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”!"); return; }
        checkResume(mode, round, limit);
    }

    function checkResume(mode, round, limit) {
        const saveKey = `save_${mode}_${round}`, doneKey = `done_${mode}_${round}`;
        const saved = localStorage.getItem(saveKey);
        if (saved && confirm("ì´ì–´ì„œ í‘¸ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            state = { ...JSON.parse(saved), sessionKey: saveKey, doneKey: doneKey };
            launch(); return;
        }
        
        localStorage.removeItem(doneKey);
        let pool = (mode === 'study') ? [...questionsDB] : (mode === 'wrong' ? Array.from(new Map(wrongStorage[round].map(q => [q.id, q])).values()) : []);
        
        if (mode === 'mock') {
            const ratio = { "ë©”ì´í¬ì—…ê°œë¡ ": 12, "í”¼ë¶€í•™": 18, "í™”ì¥í’ˆí•™": 15, "ê³µì¤‘ìœ„ìƒê´€ë¦¬í•™": 15 };
            pool = [];
            for(let s in ratio) {
                let p = questionsDB.filter(q => (q.subject === s || q.category.includes(s))).sort(() => Math.random() - 0.5);
                pool.push(...p.slice(0, ratio[s]));
            }
            pool.sort(() => Math.random() - 0.5);
        } else if (state.currentRound > 1) {
            // 2íšŒì°¨ ì´ìƒë¶€í„´ ê³¼ëª© ë‚´ ë¬¸ì œ ì…”í”Œ
            pool.sort(() => Math.random() - 0.5);
        }

        const finalQuestions = pool.map(q => {
            const opts = Object.entries(q.options).sort(() => Math.random() - 0.5);
            return { ...q, shuffledOptions: opts };
        });

        state = { mode, currentRound: round, timeLimit: limit, questions: finalQuestions, index: 0, sessionKey: saveKey, doneKey: doneKey };
        launch();
    }

    function launch() {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('quiz-app').style.display = 'block';
        window.scrollTo(0,0); renderQuestion();
    }

    function renderQuestion() {
        if(state.timerId) clearInterval(state.timerId);
        const q = state.questions[state.index];
        document.getElementById('q-category').innerText = q.subject || q.category;
        document.getElementById('q-progress').innerText = `${state.index + 1} / ${state.questions.length}`;
        document.getElementById('q-text').innerText = q.question;
        const optArea = document.getElementById('options-area'), expArea = document.getElementById('exp-area'), nextBtn = document.getElementById('next-btn');

        const optsHtml = q.shuffledOptions.map(([id, text]) => {
            if(state.currentRound === 1 && state.mode === 'study') return `<div class="option-btn ${id === q.answer ? 'correct' : ''}">${text}</div>`;
            return `<button class="option-btn" onclick="handleSelect(this, '${id}', '${q.answer}')">${text}</button>`;
        }).join('');
        optArea.innerHTML = optsHtml;

        if(state.currentRound === 1 && state.mode === 'study') {
            expArea.innerHTML = `<strong>ğŸ’¡ í•™ìŠµ:</strong> ${q.explanation}`;
            expArea.style.display = 'block'; nextBtn.style.display = 'block';
        } else if(state.currentRound === 2 && state.mode === 'study') {
            expArea.innerHTML = `<strong>ğŸ“– í•´ì„¤ ìœ ì¶”:</strong><br>${q.explanation}`;
            expArea.style.display = 'block'; nextBtn.style.display = 'none'; startTimer();
        } else {
            expArea.style.display = 'none'; nextBtn.style.display = 'none'; startTimer();
        }
        localStorage.setItem(state.sessionKey, JSON.stringify(state));
    }

    function handleSelect(btn, selected, correct) {
        clearInterval(state.timerId);
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.disabled = true);
        if(selected === correct) {
            btn.classList.add('correct');
            if(state.mode === 'wrong') {
                wrongStorage[state.currentRound === 'round' ? 'round' : 'final'] = wrongStorage[state.currentRound === 'round' ? 'round' : 'final'].filter(q => q.id !== state.questions[state.index].id);
                localStorage.setItem('makeup_wrongs', JSON.stringify(wrongStorage));
            }
            if(state.currentRound === 2 && state.mode === 'study') { setTimeout(() => nextQuestion(), 1000); return; }
        } else {
            btn.classList.add('wrong');
            if(state.mode !== 'wrong') {
                const target = state.mode === 'mock' ? 'final' : 'round';
                wrongStorage[target].push(state.questions[state.index]);
                localStorage.setItem('makeup_wrongs', JSON.stringify(wrongStorage));
            }
            btns.forEach(b => { if(b.innerText === state.questions[state.index].options[correct]) b.classList.add('correct'); });
        }
        document.getElementById('exp-area').innerHTML = `<strong>í•´ì„¤:</strong><br>${state.questions[state.index].explanation}`;
        document.getElementById('exp-area').style.display = 'block';
        document.getElementById('next-btn').style.display = 'block';
    }

    function nextQuestion() {
        state.index++;
        if(state.index < state.questions.length) renderQuestion();
        else { alert("ì™„ë£Œ!"); localStorage.setItem(state.doneKey, "true"); localStorage.removeItem(state.sessionKey); exitQuiz(); }
    }

    function startTimer() {
        if(state.timeLimit <= 0) return;
        state.timeLeft = state.timeLimit;
        state.timerId = setInterval(() => {
            state.timeLeft--;
            const m = Math.floor(state.timeLeft / 60), s = state.timeLeft % 60;
            if(document.getElementById('timer')) document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if(state.timeLeft <= 0) { clearInterval(state.timerId); nextQuestion(); }
        }, 1000);
    }

    function exitQuiz() {
        if(state.timerId) clearInterval(state.timerId);
        if(state.sessionKey) localStorage.setItem(state.sessionKey, JSON.stringify(state));
        showDashboard();
        window.scrollTo(0,0);
    }

    function resetData() { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
